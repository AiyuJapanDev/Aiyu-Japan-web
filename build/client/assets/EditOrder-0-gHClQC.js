import{A as k,t as B,a as u,p as e,w as L}from"./chunk-4WY6JWTD-CQ2BrMui.js";import{P as T}from"./ProtectedRoute-DFjb99Eu.js";import{C as g,a as q,b as P,c as D,d as U}from"./card-SCvgtUFv.js";import{B as m}from"./button-B0x8FPUr.js";import{I as N}from"./input-CM33OdNU.js";import{T as z}from"./textarea-DhCnVIFz.js";import{L as j}from"./label-DN8oXECS.js";import{C as H,B as C,n as G}from"./badge-CCGCsnjh.js";import{s as d}from"./client-D-irrw7s.js";import{t as n}from"./use-toast-aoUui9pM.js";import{u as J}from"./AppContext-ASKE5L8w.js";import{A as K}from"./arrow-left-Dj3pATct.js";import{F as M,T as Q}from"./trash-2-BEv6Pjd1.js";import{P as V}from"./plus-DnVR-hSP.js";import{S as W}from"./save-Cvtw8xcv.js";import"./useAuth-DROiUoFu.js";import"./index-BNeLBswU.js";import"./utils-CDN07tui.js";import"./index-CwuhT9dy.js";import"./index-B_jtOnfb.js";import"./index-DQ6zQjx3.js";import"./tslib.es6-DcwbYiNs.js";function X(){const{t}=J(),{orderId:p}=k(),c=B(),[h,$]=u.useState(null),[l,x]=u.useState([]),[O,E]=u.useState(!0),[v,w]=u.useState(!1);u.useEffect(()=>{p&&R()},[p]);const R=async()=>{try{const{data:{user:r}}=await d.auth.getUser();if(!r){c("/auth");return}const{data:s,error:a}=await d.from("orders").select(`
          *,
          order_items (
            id,
            product_request:product_requests (*)
          )
        `).eq("id",p).eq("user_id",r.id).eq("is_rejected",!0).single();if(a||!s){n({title:t("error"),description:t("orderNotFound"),variant:"destructive"}),c("/user-dashboard");return}$(s);const o=s.order_items.map(i=>({id:i.product_request.id,product_url:i.product_request.product_url,item_name:i.product_request.item_name,quantity:i.product_request.quantity||1,notes:i.product_request.notes,has_purchase_issue:i.product_request.has_purchase_issue,purchase_issue_description:i.product_request.purchase_issue_description,isNew:!1,toDelete:!1}));x(o)}catch(r){console.error("Error fetching order:",r),n({title:t("error"),description:t("loadingOrderDetails"),variant:"destructive"})}finally{E(!1)}},f=(r,s,a)=>{const o=[...l];o[r]={...o[r],[s]:a},x(o)},F=()=>{x([...l,{id:`new-${Date.now()}`,product_url:"",item_name:"",quantity:1,notes:"",isNew:!0,toDelete:!1}])},S=r=>{const s=[...l];s[r].toDelete=!s[r].toDelete,x(s)},A=async()=>{const r=l.filter(s=>!s.toDelete);if(r.length===0){n({title:t("error"),description:t("atLeastOneProductError"),variant:"destructive"});return}for(const s of r)if(!s.product_url){n({title:t("error"),description:t("allProductsUrlError"),variant:"destructive"});return}w(!0);try{const{data:{user:s}}=await d.auth.getUser();if(!s)return;const{data:a}=await d.from("profiles").select("full_name, user_personal_id").eq("id",s.id).single(),o=a?.full_name||"Unknown User",i=a?.user_personal_id?`#${a.user_personal_id}`:"",{data:y,error:b}=await d.from("orders").insert({user_id:s.id,status:"preparing",is_resubmitted:!0,parent_order_id:p}).select().single();if(b)throw b;await G("order_resubmitted",`Order resubmitted by ${o} ${i}.`,y.id);for(const _ of r){const{data:I}=await d.from("product_requests").insert({user_id:s.id,product_url:_.product_url,item_name:_.item_name,quantity:_.quantity,notes:_.notes,status:"requested"}).select().single();await d.from("order_items").insert({order_id:y.id,product_request_id:I.id})}n({title:t("success"),description:t("orderResubmittedSuccess")}),c("/user-dashboard")}catch(s){console.error("Error resubmitting order:",s),n({title:t("error"),description:t("orderResubmitError"),variant:"destructive"})}finally{w(!1)}};return O?e.jsx("div",{className:"text-center py-8",children:t("loadingOrderDetails")}):h?e.jsxs("div",{className:"max-w-4xl mx-auto space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(m,{variant:"ghost",size:"icon",onClick:()=>c("/user-dashboard"),children:e.jsx(K,{className:"h-4 w-4"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:t("editRejectedOrder")}),e.jsxs("p",{className:"text-muted-foreground",children:[t("orderNumber")," ",h.order_personal_id]})]})]}),h.rejection_reason&&e.jsxs(g,{className:"border-destructive",children:[e.jsx(q,{children:e.jsxs(P,{className:"flex items-center gap-2 text-destructive",children:[e.jsx(H,{className:"h-5 w-5"}),t("orderRejectionReasonTitle")]})}),e.jsx(D,{children:e.jsx("p",{children:h.rejection_reason})})]}),e.jsxs(g,{children:[e.jsxs(q,{children:[e.jsx(P,{children:t("productsInOrder")}),e.jsx(U,{children:t("editOrderDescription")})]}),e.jsxs(D,{className:"space-y-4",children:[l.map((r,s)=>e.jsx(g,{className:`p-4 ${r.toDelete?"opacity-50":""} ${r.has_purchase_issue?"border-yellow-500":""}`,children:e.jsxs("div",{className:"space-y-4",children:[r.has_purchase_issue&&r.purchase_issue_description&&e.jsxs("div",{className:"p-3 bg-yellow-50 rounded-lg flex items-start gap-2",children:[e.jsx(M,{className:"h-4 w-4 text-yellow-600 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-yellow-900",children:t("productIssue")}),e.jsx("p",{className:"text-sm text-yellow-700",children:r.purchase_issue_description})]})]}),e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{children:[e.jsx(j,{htmlFor:`url-${s}`,children:"Product URL *"}),e.jsx(N,{id:`url-${s}`,value:r.product_url,onChange:a=>f(s,"product_url",a.target.value),placeholder:"https://example.com/product",disabled:r.toDelete})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(j,{htmlFor:`name-${s}`,children:t("productName")}),e.jsx(N,{id:`name-${s}`,value:r.item_name||"",onChange:a=>f(s,"item_name",a.target.value),placeholder:t("productNamePlaceholder"),disabled:r.toDelete})]}),e.jsxs("div",{children:[e.jsx(j,{htmlFor:`quantity-${s}`,children:t("quantity")}),e.jsx(N,{id:`quantity-${s}`,type:"number",min:"1",value:r.quantity,onChange:a=>f(s,"quantity",parseInt(a.target.value)||1),disabled:r.toDelete})]})]}),e.jsxs("div",{children:[e.jsx(j,{htmlFor:`notes-${s}`,children:t("productNotes")}),e.jsx(z,{id:`notes-${s}`,value:r.notes||"",onChange:a=>f(s,"notes",a.target.value),placeholder:t("productNotesPlaceholder"),disabled:r.toDelete})]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex gap-2",children:[r.isNew&&e.jsx(C,{variant:"secondary",children:t("newProductBadge")}),r.toDelete&&e.jsx(C,{variant:"destructive",children:t("willBeRemoved")})]}),e.jsxs(m,{variant:r.toDelete?"default":"destructive",size:"sm",onClick:()=>S(s),children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),r.toDelete?t("restore"):t("remove")]})]})]})},r.id)),e.jsxs(m,{variant:"outline",onClick:F,className:"w-full",children:[e.jsx(V,{className:"h-4 w-4 mr-2"}),t("addNewProduct")]})]})]}),e.jsxs("div",{className:"flex gap-4 justify-end",children:[e.jsx(m,{variant:"outline",onClick:()=>c("/user-dashboard"),disabled:v,children:t("cancel")}),e.jsxs(m,{onClick:A,disabled:v||l.filter(r=>!r.toDelete).length===0,children:[e.jsx(W,{className:"h-4 w-4 mr-2"}),t(v?"resubmitting":"resubmitOrder")]})]})]}):e.jsx("div",{className:"text-center py-8",children:t("orderNotFound")})}const ge=L(function(){return e.jsx(T,{children:e.jsx("div",{className:"container mx-auto py-8 px-4",children:e.jsx(X,{})})})});export{ge as default};
