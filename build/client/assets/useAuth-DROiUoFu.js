import{a as i,p as k}from"./chunk-4WY6JWTD-CQ2BrMui.js";import{s as n}from"./client-D-irrw7s.js";import{u as C}from"./use-toast-aoUui9pM.js";const y=async(a,s,c)=>{try{console.log("fetchUserMeta - Starting fetch for user:",a);const[{data:l,error:d},{data:u,error:f}]=await Promise.all([n.from("profiles").select("id, full_name, email, phone_number, address, address_notes, country, postal_code, user_personal_id, city, state").eq("id",a).maybeSingle(),n.from("user_roles").select("role").eq("user_id",a).maybeSingle()]);console.log("fetchUserMeta - Profile data:",l,"Profile error:",d),console.log("fetchUserMeta - Role data:",u,"Role error:",f),d||!l?(console.log("fetchUserMeta - Setting profile to null"),s(null)):(console.log("fetchUserMeta - Setting profile:",l),s(l)),f?(console.log("fetchUserMeta - Role error, defaulting to user"),c("user")):u?(console.log("fetchUserMeta - Setting role:",u.role),c(u.role)):(console.log("fetchUserMeta - No role data, defaulting to user"),c("user"))}catch(l){console.error("[AuthUtils] Error fetching user meta:",l),s(null),c("user")}},S=i.createContext(void 0),$=({children:a})=>{const[s,c]=i.useState(null),[l,d]=i.useState(null),[u,f]=i.useState(!0),[h,m]=i.useState(null),[U,p]=i.useState(null),{toast:o}=C(),v=h==="admin";console.log("AuthProvider - user:",s?.id,"userRole:",h,"isAdmin:",v),i.useEffect(()=>{const{data:{subscription:r}}=n.auth.onAuthStateChange((t,e)=>{console.log("Auth state change:",t,"user:",e?.user?.id),d(e),c(e?.user??null),f(!1)});return n.auth.getSession().then(({data:{session:t}})=>{console.log("Initial session check:",t?.user?.id),d(t),c(t?.user??null),f(!1)}),()=>r.unsubscribe()},[]),i.useEffect(()=>{s?(console.log("Fetching user meta for:",s.id),y(s.id,p,m)):(console.log("No user, clearing role and profile"),m(null),p(null))},[s?.id]);const b=async(r,t,e,g)=>{const M=`${window.location.origin}/auth?verified=true`,R={full_name:e,...g||{}},{error:w}=await n.auth.signUp({email:r,password:t,options:{emailRedirectTo:M,data:R}});return o(w?{title:"Sign up failed",description:w.message,variant:"destructive"}:{title:"Check your email",description:"We've sent you a verification link."}),{error:w}},A=async(r,t)=>{const{error:e}=await n.auth.signInWithPassword({email:r,password:t});return o(e?{title:"Sign in failed",description:e.message,variant:"destructive"}:{title:"Welcome back!",description:"You've been signed in successfully."}),{error:e}},P=async()=>{const{error:r}=await n.auth.signOut();o(r?{title:"Sign out failed",description:r.message,variant:"destructive"}:{title:"Signed out",description:"You've been signed out successfully."})},_=async r=>{const t=`${window.location.origin}/auth/reset-password`,{error:e}=await n.auth.resetPasswordForEmail(r,{redirectTo:t});return o(e?{title:"Password reset failed",description:e.message,variant:"destructive"}:{title:"Check your email",description:"We've sent you a password reset link."}),{error:e}},x=async(r,t)=>{if(!v){const g={message:"Only admins can assign roles"};return o({title:"Permission denied",description:g.message,variant:"destructive"}),{error:g}}const{error:e}=await n.from("user_roles").upsert({user_id:r,role:t,assigned_by:s?.id});return o(e?{title:"Role assignment failed",description:e.message,variant:"destructive"}:{title:"Role assigned",description:`User role updated to ${t}`}),{error:e}},E=async()=>{s?.id&&await y(s.id,p,m)};return k.jsx(S.Provider,{value:{user:s,session:l,loading:u,userRole:h,isAdmin:v,profile:U,signUp:b,signIn:A,signOut:P,resetPassword:_,assignRole:x,refreshProfile:E},children:a})},j=()=>{const a=i.useContext(S);if(!a)throw new Error("useAuth must be used within an AuthProvider");return a};export{$ as A,j as u};
